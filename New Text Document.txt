
BEGIN
SELECT SUM(X.plannedqty) As planned, SUM(X.goodqty) as produced 
    FROM [Applications].[dbo].[assy_prodplan]
	WHERE cellid = 14 and shiftid 
		







SELECT X.processid, SUM(X.passed) As passed, SUM(X.failed) as failed 
    FROM (	
	SELECT CONVERT(date,CONVERT(date,(DATEADD(DAY,-1,GETDATE())))) as ddate, MAIN.snr, MAIN.processid, MAIN.cellid, SUM(MAIN.passed) as passed, SUM(MAIN.failed) as failed 
    FROM (
	--ELŐZŐ NAP 21:59-ig
	SELECT f.snr, f.processid, f.cellid, SUM(-1*f.passed) As passed, SUM(-1*f.failed) As failed 
    FROM [Applications_DB05].[dbo].[fm_datas] AS f 
    WHERE (DATEPART(HOUR, f.ddate) = 21) and CONVERT(date, f.ddate) = CONVERT(date, CONVERT(date,(DATEADD(DAY,-1,GETDATE())))) and f.snr != 0 
	GROUP BY f.processid, f.snr, f.cellid     
    UNION   
	-- ELŐZŐ NAP 23:59-ig
    SELECT f.snr, f.processid, f.cellid, SUM(f.passed) As passed, SUM(f.failed) As failed 
    FROM [Applications_DB05].[dbo].[fm_datas] AS f 
    WHERE (DATEPART(HOUR, f.ddate) = 23) and CONVERT(date, f.ddate) = CONVERT(date, CONVERT(date,(DATEADD(DAY,-1,GETDATE())))) and f.snr != 0 
    GROUP BY f.processid, f.snr, f.cellid	
	UNION
	--AKTUÁLIS NAP AKTUÁLIS ÓRÁIG
	SELECT f.snr, f.processid, f.cellid, SUM(f.passed) As passed, SUM(f.failed) As failed 
    FROM [Applications_DB05].[dbo].[fm_datas] AS f 
    WHERE (DATEPART(HOUR, f.ddate) = DATEPART(HOUR,GETDATE())) and CONVERT(date, f.ddate) = CONVERT(date, CONVERT(date,(DATEADD(DAY,0,GETDATE())))) and f.snr != 0 
    GROUP BY f.processid, f.snr, f.cellid	
	) AS MAIN 
    INNER JOIN [Applications_DB05].[dbo].[fm_cells] AS C ON C.cellid = MAIN.cellid 
    WHERE C.assy_cellid = ".$selectOption." 
	GROUP BY MAIN.snr, MAIN.processid, MAIN.cellid	
	) AS X
    GROUP BY X.processid
END